<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyranges.statistics &mdash; pyranges  0.0.124 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pyranges
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial of PyRanges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html">Introduction to PyRanges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#loading-creating-pyranges">Loading/Creating PyRanges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#writing-pyranges-to-disk">Writing PyRanges to disk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#inspecting-pyranges">Inspecting PyRanges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#accessing-data">Accessing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#operating-with-data">Operating with data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#overlapping-and-matching-pyranges">Overlapping and matching PyRanges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#summary-statistics">Summary statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#computing-with-pyranges">Computing with PyRanges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#working-at-the-transcript-level">Working at the transcript level</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#fetching-external-gene-tracks">Fetching external gene tracks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_book.html#rles-run-length-encodings">RLEs: run length encodings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyranges</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../pyranges.html">pyranges</a></li>
      <li class="breadcrumb-item active">pyranges.statistics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyranges.statistics</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Statistics useful for genomics.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pyranges</span> <span class="k">as</span> <span class="nn">pr</span>
<span class="kn">from</span> <span class="nn">pyranges.multithreaded</span> <span class="kn">import</span> <span class="n">pyrange_apply</span>

<span class="kn">from</span> <span class="nn">pyranges.methods.statistics</span> <span class="kn">import</span> <span class="n">_relative_distance</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;simes&quot;</span><span class="p">,</span> <span class="s2">&quot;fisher_exact&quot;</span><span class="p">,</span> <span class="s2">&quot;StatisticsMethods&quot;</span><span class="p">,</span> <span class="s2">&quot;fdr&quot;</span><span class="p">,</span> <span class="s2">&quot;rowbased_rankdata&quot;</span><span class="p">,</span> <span class="s2">&quot;rowbased_pearson&quot;</span><span class="p">,</span> <span class="s2">&quot;rowbased_spearman&quot;</span><span class="p">,</span> <span class="s2">&quot;mcc&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="fdr"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.fdr">[docs]</a><span class="k">def</span> <span class="nf">fdr</span><span class="p">(</span><span class="n">p_vals</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adjust p-values with Benjamini-Hochberg.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array-like</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pandas.DataFrame</span>

<span class="sd">        DataFrame where values are order of data.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.random(10) / 100</span>

<span class="sd">    &gt;&gt;&gt; gr = pr.random(10)</span>
<span class="sd">    &gt;&gt;&gt; gr.PValue = x</span>
<span class="sd">    &gt;&gt;&gt; gr</span>
<span class="sd">    +--------------+-----------+-----------+--------------+----------------------+</span>
<span class="sd">    | Chromosome   | Start     | End       | Strand       | PValue               |</span>
<span class="sd">    | (category)   | (int32)   | (int32)   | (category)   | (float64)            |</span>
<span class="sd">    |--------------+-----------+-----------+--------------+----------------------|</span>
<span class="sd">    | chr1         | 176601938 | 176602038 | +            | 0.005488135039273248 |</span>
<span class="sd">    | chr1         | 155082851 | 155082951 | -            | 0.007151893663724195 |</span>
<span class="sd">    | chr2         | 211134424 | 211134524 | -            | 0.006027633760716439 |</span>
<span class="sd">    | chr9         | 78826761  | 78826861  | -            | 0.005448831829968969 |</span>
<span class="sd">    | ...          | ...       | ...       | ...          | ...                  |</span>
<span class="sd">    | chr16        | 52216522  | 52216622  | +            | 0.004375872112626925 |</span>
<span class="sd">    | chr17        | 8085927   | 8086027   | -            | 0.008917730007820798 |</span>
<span class="sd">    | chr19        | 17333425  | 17333525  | +            | 0.009636627605010294 |</span>
<span class="sd">    | chr22        | 16728001  | 16728101  | +            | 0.003834415188257777 |</span>
<span class="sd">    +--------------+-----------+-----------+--------------+----------------------+</span>
<span class="sd">    Stranded PyRanges object has 10 rows and 5 columns from 9 chromosomes.</span>
<span class="sd">    For printing, the PyRanges was sorted on Chromosome and Strand.</span>

<span class="sd">    &gt;&gt;&gt; gr.FDR = pr.stats.fdr(gr.PValue)</span>
<span class="sd">    &gt;&gt;&gt; gr.print(formatting={&quot;PValue&quot;: &quot;{:.4f}&quot;, &quot;FDR&quot;: &quot;{:.4}&quot;})</span>
<span class="sd">    +--------------+-----------+-----------+--------------+-------------+-------------+</span>
<span class="sd">    | Chromosome   | Start     | End       | Strand       | PValue      | FDR         |</span>
<span class="sd">    | (category)   | (int32)   | (int32)   | (category)   | (float64)   | (float64)   |</span>
<span class="sd">    |--------------+-----------+-----------+--------------+-------------+-------------|</span>
<span class="sd">    | chr1         | 176601938 | 176602038 | +            | 0.0055      | 0.01098     |</span>
<span class="sd">    | chr1         | 155082851 | 155082951 | -            | 0.0072      | 0.00894     |</span>
<span class="sd">    | chr2         | 211134424 | 211134524 | -            | 0.0060      | 0.01005     |</span>
<span class="sd">    | chr9         | 78826761  | 78826861  | -            | 0.0054      | 0.01362     |</span>
<span class="sd">    | ...          | ...       | ...       | ...          | ...         | ...         |</span>
<span class="sd">    | chr16        | 52216522  | 52216622  | +            | 0.0044      | 0.01459     |</span>
<span class="sd">    | chr17        | 8085927   | 8086027   | -            | 0.0089      | 0.009909    |</span>
<span class="sd">    | chr19        | 17333425  | 17333525  | +            | 0.0096      | 0.009637    |</span>
<span class="sd">    | chr22        | 16728001  | 16728101  | +            | 0.0038      | 0.03834     |</span>
<span class="sd">    +--------------+-----------+-----------+--------------+-------------+-------------+</span>
<span class="sd">    Stranded PyRanges object has 10 rows and 6 columns from 9 chromosomes.</span>
<span class="sd">    For printing, the PyRanges was sorted on Chromosome and Strand.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">rankdata</span>
    <span class="n">ranked_p_values</span> <span class="o">=</span> <span class="n">rankdata</span><span class="p">(</span><span class="n">p_vals</span><span class="p">)</span>
    <span class="n">fdr</span> <span class="o">=</span> <span class="n">p_vals</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_vals</span><span class="p">)</span> <span class="o">/</span> <span class="n">ranked_p_values</span>
    <span class="n">fdr</span><span class="p">[</span><span class="n">fdr</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">fdr</span></div>


<div class="viewcode-block" id="fisher_exact"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.fisher_exact">[docs]</a><span class="k">def</span> <span class="nf">fisher_exact</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">pseudocount</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fisher&#39;s exact for contingency tables.</span>

<span class="sd">    Computes the hypotheses two-sided, less and greater at the same time.</span>

<span class="sd">    The odds-ratio is</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tp : array-like of int</span>

<span class="sd">        Top left square of contingency table (true positives).</span>

<span class="sd">    fp : array-like of int</span>

<span class="sd">        Top right square of contingency table (false positives).</span>

<span class="sd">    fn : array-like of int</span>

<span class="sd">        Bottom left square of contingency table (false negatives).</span>

<span class="sd">    tn : array-like of int</span>

<span class="sd">        Bottom right square of contingency table (true negatives).</span>

<span class="sd">    pseudocount : float, default 0</span>

<span class="sd">        Values &gt; 0 allow Odds Ratio to always be a finite number.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The odds-ratio is computed thusly:</span>

<span class="sd">    ``((tp + pseudocount) / (fp + pseudocount)) / ((fn + pseudocount) / (tn + pseudocount))``</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>

<span class="sd">        DataFrame with columns OR and P, PLeft and PRight.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pr.stats.fdr : correct for multiple testing</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; d = {&quot;TP&quot;: [12, 0], &quot;FP&quot;: [5, 12], &quot;TN&quot;: [29, 10], &quot;FN&quot;: [2, 2]}</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame(d)</span>
<span class="sd">    &gt;&gt;&gt; df</span>
<span class="sd">       TP  FP  TN  FN</span>
<span class="sd">    0  12   5  29   2</span>
<span class="sd">    1   0  12  10   2</span>

<span class="sd">    &gt;&gt;&gt; pr.stats.fisher_exact(df.TP, df.FP, df.TN, df.FN)</span>
<span class="sd">             OR         P     PLeft    PRight</span>
<span class="sd">    0  0.165517  0.080269  0.044555  0.994525</span>
<span class="sd">    1  0.000000  0.000067  0.000034  1.000000</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">fisher</span> <span class="kn">import</span> <span class="n">pvalue_npy</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;fisher needs to be installed to use fisher exact. pip install fisher or conda install -c bioconda fisher.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
    <span class="n">tn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>

    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">twosided</span> <span class="o">=</span> <span class="n">pvalue_npy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">tn</span><span class="p">)</span>

    <span class="n">OR</span> <span class="o">=</span> <span class="p">((</span><span class="n">tp</span> <span class="o">+</span> <span class="n">pseudocount</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="n">pseudocount</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">fn</span> <span class="o">+</span> <span class="n">pseudocount</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">pseudocount</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;OR&quot;</span><span class="p">:</span> <span class="n">OR</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="n">twosided</span><span class="p">,</span> <span class="s2">&quot;PLeft&quot;</span><span class="p">:</span> <span class="n">left</span><span class="p">,</span> <span class="s2">&quot;PRight&quot;</span><span class="p">:</span> <span class="n">right</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="mcc"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.mcc">[docs]</a><span class="k">def</span> <span class="nf">mcc</span><span class="p">(</span><span class="n">grs</span><span class="p">,</span> <span class="n">genome</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute Matthew&#39;s correlation coefficient for PyRanges overlaps.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grs : list of PyRanges</span>

<span class="sd">        PyRanges to compare.</span>

<span class="sd">    genome : DataFrame or dict, default None</span>

<span class="sd">        Should contain chromosome sizes. By default, end position of the</span>
<span class="sd">        rightmost intervals are used as proxies for the chromosome size, but</span>
<span class="sd">        it is recommended to use a genome.</span>

<span class="sd">    labels : list of str, default None</span>

<span class="sd">        Names to give the PyRanges in the output.</span>

<span class="sd">    strand : bool, default False</span>

<span class="sd">        Whether to compute correlations per strand.</span>

<span class="sd">    verbose : bool, default False</span>

<span class="sd">        Warn if some chromosomes are in the genome, but not in the PyRanges.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; chromsizes = {&quot;chrM&quot;: 16000}</span>
<span class="sd">    &gt;&gt;&gt; grs = [pr.random(chromsizes=chromsizes) for _ in range(3)]</span>
<span class="sd">    &gt;&gt;&gt; labels = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
<span class="sd">    &gt;&gt;&gt; mcc = pr.stats.mcc(grs, labels=labels, genome=chromsizes)</span>
<span class="sd">    &gt;&gt;&gt; mcc</span>
<span class="sd">       T  F     TP  FP  TN  FN       MCC</span>
<span class="sd">    0  a  a  15920   0  80   0  1.000000</span>
<span class="sd">    1  a  b  15875  65  15  45  0.213109</span>
<span class="sd">    3  a  c  15896  72   8  24  0.155496</span>
<span class="sd">    2  b  a  15875  45  15  65  0.213109</span>
<span class="sd">    5  b  b  15940   0  60   0  1.000000</span>
<span class="sd">    6  b  c  15916  52   8  24  0.180354</span>
<span class="sd">    4  c  a  15896  24   8  72  0.155496</span>
<span class="sd">    7  c  b  15916  24   8  52  0.180354</span>
<span class="sd">    8  c  c  15968   0  32   0  1.000000</span>

<span class="sd">    To create a symmetric matrix (useful for heatmaps of correlations):</span>

<span class="sd">    &gt;&gt;&gt; mcc.set_index([&quot;T&quot;, &quot;F&quot;]).MCC.unstack()</span>
<span class="sd">    F         a         b         c</span>
<span class="sd">    T</span>
<span class="sd">    a  1.000000  0.213109  0.155496</span>
<span class="sd">    b  0.213109  1.000000  0.180354</span>
<span class="sd">    c  0.155496  0.180354  1.000000&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations_with_replacement</span><span class="p">,</span> <span class="n">chain</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grs</span><span class="p">)))</span>
        <span class="n">_labels</span> <span class="o">=</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">_labels</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">grs</span><span class="p">)</span>
        <span class="n">_labels</span> <span class="o">=</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># remove all non-loc columns before computation</span>
    <span class="n">grs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span> <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grs</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">genome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genome</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">)):</span>
            <span class="n">genome_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">genome</span><span class="o">.</span><span class="n">End</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">genome_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">genome</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># check that genome definition does not have many more</span>
            <span class="c1"># chromosomes than datafiles</span>
            <span class="n">gr_cs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">gr</span><span class="o">.</span><span class="n">chromosomes</span> <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grs</span><span class="p">]))</span>

            <span class="n">g_cs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">genome</span><span class="o">.</span><span class="n">chromosomes</span><span class="p">)</span>
            <span class="n">surplus</span> <span class="o">=</span> <span class="n">g_cs</span> <span class="o">-</span> <span class="n">gr_cs</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surplus</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following chromosomes are in the genome, but not the PyRanges:&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surplus</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strand</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">make_stranded</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Strand&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
                <span class="n">df2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Strand&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span>

            <span class="n">genome</span> <span class="o">=</span> <span class="n">genome</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">make_stranded</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">grs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gr</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">End</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">genome_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">strandedness</span> <span class="o">=</span> <span class="s2">&quot;same&quot;</span> <span class="k">if</span> <span class="n">strand</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">rowdicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">lf</span><span class="p">),</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_labels</span><span class="p">,</span> <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">grs</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">lt</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lt</span> <span class="o">==</span> <span class="n">lf</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">strand</span><span class="p">:</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">length</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tn</span> <span class="o">=</span> <span class="n">genome_length</span> <span class="o">-</span> <span class="n">tp</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rowdicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">lf</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;TN&quot;</span><span class="p">:</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;FN&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;MCC&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="s2">&quot;+ -&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="n">tp</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">tn</span> <span class="o">=</span> <span class="n">genome_length</span> <span class="o">-</span> <span class="n">tp</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">rowdicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">lf</span><span class="p">,</span> <span class="s2">&quot;Strand&quot;</span><span class="p">:</span> <span class="n">strand</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;TN&quot;</span><span class="p">:</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;FN&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;MCC&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="k">continue</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">strandedness</span><span class="o">=</span><span class="n">strandedness</span><span class="p">)</span>
            <span class="n">tp_gr</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">new_position</span><span class="p">(</span><span class="s2">&quot;intersection&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strand</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="s2">&quot;+ -&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="n">tp</span> <span class="o">=</span> <span class="n">tp_gr</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">tp</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">tp</span>
                    <span class="n">tn</span> <span class="o">=</span> <span class="n">genome_length</span> <span class="o">-</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="n">mcc</span> <span class="o">=</span> <span class="n">_mcc</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="n">rowdicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">lf</span><span class="p">,</span> <span class="s2">&quot;Strand&quot;</span><span class="p">:</span> <span class="n">strand</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;TN&quot;</span><span class="p">:</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;FN&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;MCC&quot;</span><span class="p">:</span> <span class="n">mcc</span><span class="p">})</span>
                    <span class="n">rowdicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">lf</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span> <span class="s2">&quot;Strand&quot;</span><span class="p">:</span> <span class="n">strand</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;TN&quot;</span><span class="p">:</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;FN&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;MCC&quot;</span><span class="p">:</span> <span class="n">mcc</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="n">tp_gr</span><span class="o">.</span><span class="n">length</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">tp</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">tp</span>
                <span class="n">tn</span> <span class="o">=</span> <span class="n">genome_length</span> <span class="o">-</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
                <span class="n">mcc</span> <span class="o">=</span> <span class="n">_mcc</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

                <span class="n">rowdicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">lf</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;TN&quot;</span><span class="p">:</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;FN&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;MCC&quot;</span><span class="p">:</span> <span class="n">mcc</span><span class="p">})</span>
                <span class="n">rowdicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">lf</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">lt</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span> <span class="n">tp</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;TN&quot;</span><span class="p">:</span> <span class="n">tn</span><span class="p">,</span> <span class="s2">&quot;FN&quot;</span><span class="p">:</span> <span class="n">fp</span><span class="p">,</span> <span class="s2">&quot;MCC&quot;</span><span class="p">:</span> <span class="n">mcc</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">rowdicts</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="rowbased_spearman"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.rowbased_spearman">[docs]</a><span class="k">def</span> <span class="nf">rowbased_spearman</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fast row-based Spearman&#39;s correlation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : matrix-like</span>

<span class="sd">        2D numerical matrix. Same size as y.</span>

<span class="sd">    y : matrix-like</span>

<span class="sd">        2D numerical matrix. Same size as x.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>

<span class="sd">        Array with same length as input, where values are P-values.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pyranges.statistics.rowbased_pearson : fast row-based Pearson&#39;s correlation.</span>
<span class="sd">    pr.stats.fdr : correct for multiple testing</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randint(10, size=(10, 10))</span>
<span class="sd">    &gt;&gt;&gt; y = np.random.randint(10, size=(10, 10))</span>

<span class="sd">    Perform Spearman&#39;s correlation pairwise on each row in 10x10 matrixes:</span>

<span class="sd">    &gt;&gt;&gt; pr.stats.rowbased_spearman(x, y)</span>
<span class="sd">    array([ 0.07523548, -0.24838724,  0.03703774,  0.24194052,  0.04778621,</span>
<span class="sd">           -0.23913505,  0.12923138,  0.26840486,  0.13292204, -0.29846295])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">rx</span> <span class="o">=</span> <span class="n">rowbased_rankdata</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">rowbased_rankdata</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rowbased_pearson</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">)</span></div>


<div class="viewcode-block" id="rowbased_pearson"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.rowbased_pearson">[docs]</a><span class="k">def</span> <span class="nf">rowbased_pearson</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fast row-based Pearson&#39;s correlation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : matrix-like</span>

<span class="sd">        2D numerical matrix. Same size as y.</span>

<span class="sd">    y : matrix-like</span>

<span class="sd">        2D numerical matrix. Same size as x.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>

<span class="sd">        Array with same length as input, where values are P-values.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pyranges.statistics.rowbased_spearman : fast row-based Spearman&#39;s correlation.</span>
<span class="sd">    pr.stats.fdr : correct for multiple testing</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randint(10, size=(10, 10))</span>
<span class="sd">    &gt;&gt;&gt; y = np.random.randint(10, size=(10, 10))</span>

<span class="sd">    Perform Pearson&#39;s correlation pairwise on each row in 10x10 matrixes:</span>

<span class="sd">    &gt;&gt;&gt; pr.stats.rowbased_pearson(x, y)</span>
<span class="sd">    array([ 0.20349603, -0.01667236, -0.01448763, -0.00442322,  0.06527234,</span>
<span class="sd">           -0.36710862,  0.14978726,  0.32360286,  0.17209191, -0.08902829])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Thanks to https://github.com/dengemann</span>

    <span class="k">def</span> <span class="nf">ss</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">mx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">my</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">xm</span><span class="p">,</span> <span class="n">ym</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mx</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">y</span> <span class="o">-</span> <span class="n">my</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">r_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">xm</span> <span class="o">*</span> <span class="n">ym</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r_den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ss</span><span class="p">(</span><span class="n">xm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ss</span><span class="p">(</span><span class="n">ym</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">r_num</span> <span class="o">/</span> <span class="n">r_den</span>

    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="rowbased_rankdata"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.rowbased_rankdata">[docs]</a><span class="k">def</span> <span class="nf">rowbased_rankdata</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rank order of entries in each row.</span>

<span class="sd">    Same as SciPy rankdata with method=mean.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : matrix-like</span>

<span class="sd">        The data to find order of.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Pandas.DataFrame</span>

<span class="sd">        DataFrame where values are order of data.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randint(10, size=(3, 10))</span>
<span class="sd">    &gt;&gt;&gt; x</span>
<span class="sd">    array([[5, 0, 3, 3, 7, 9, 3, 5, 2, 4],</span>
<span class="sd">           [7, 6, 8, 8, 1, 6, 7, 7, 8, 1],</span>
<span class="sd">           [5, 9, 8, 9, 4, 3, 0, 3, 5, 0]])</span>
<span class="sd">    &gt;&gt;&gt; pr.stats.rowbased_rankdata(x)</span>
<span class="sd">         0    1    2    3    4     5    6    7    8    9</span>
<span class="sd">    0  7.5  1.0  4.0  4.0  9.0  10.0  4.0  7.5  2.0  6.0</span>
<span class="sd">    1  6.0  3.5  9.0  9.0  1.5   3.5  6.0  6.0  9.0  1.5</span>
<span class="sd">    2  6.5  9.5  8.0  9.5  5.0   3.5  1.5  3.5  6.5  1.5</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sorter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">intp</span><span class="p">)</span>

    <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">np</span><span class="o">.</span><span class="n">put_along_axis</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">sorter</span><span class="p">,</span> <span class="n">ranks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">dc</span><span class="p">,</span> <span class="n">sorter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dc</span><span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span> <span class="n">res</span><span class="p">])</span>

    <span class="n">dense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">obs</span><span class="p">),</span> <span class="n">inv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">len_r</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nonzero</span><span class="p">)</span>
    <span class="n">dense</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dense</span><span class="p">)</span>

    <span class="n">ranks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_nonzero</span><span class="p">,</span> <span class="n">nzdf</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">nonzero</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">r</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nzdf</span><span class="p">)</span>

        <span class="n">_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">nz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nz</span><span class="p">))</span> <span class="o">*</span> <span class="n">len_r</span><span class="p">])</span>
        <span class="n">_dense</span> <span class="o">=</span> <span class="n">dense</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">nzdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="n">_result</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">_count</span><span class="p">,</span> <span class="n">_dense</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">_count</span><span class="p">,</span> <span class="n">_dense</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">nzdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ranks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final</span></div>


<div class="viewcode-block" id="simes"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.simes">[docs]</a><span class="k">def</span> <span class="nf">simes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">pcol</span><span class="p">,</span> <span class="n">keep_position</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply Simes method for giving dependent events a p-value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>

<span class="sd">        Data to analyse with Simes.</span>

<span class="sd">    groupby : str or list of str</span>

<span class="sd">        Features equal in these columns will be merged with Simes.</span>

<span class="sd">    pcol : str</span>

<span class="sd">        Name of column with p-values.</span>

<span class="sd">    keep_position : bool, default False</span>

<span class="sd">        Keep columns &quot;Chromosome&quot;, &quot;Start&quot;, &quot;End&quot; and &quot;Strand&quot; if they exist.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>

<span class="sd">    pr.stats.fdr : correct for multiple testing</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; s = &#39;&#39;&#39;Chromosome Start End Strand Gene PValue</span>
<span class="sd">    ... 1 10 20 + P53 0.0001</span>
<span class="sd">    ... 1 20 20 + P53 0.0002</span>
<span class="sd">    ... 1 30 20 + P53 0.0003</span>
<span class="sd">    ... 2 60 65 - FOX 0.05</span>
<span class="sd">    ... 2 70 75 - FOX 0.0000001</span>
<span class="sd">    ... 2 80 90 - FOX 0.0000021&#39;&#39;&#39;</span>

<span class="sd">    &gt;&gt;&gt; gr = pr.from_string(s)</span>
<span class="sd">    &gt;&gt;&gt; gr</span>
<span class="sd">    +--------------+-----------+-----------+--------------+------------+-------------+</span>
<span class="sd">    |   Chromosome |     Start |       End | Strand       | Gene       |      PValue |</span>
<span class="sd">    |   (category) |   (int32) |   (int32) | (category)   | (object)   |   (float64) |</span>
<span class="sd">    |--------------+-----------+-----------+--------------+------------+-------------|</span>
<span class="sd">    |            1 |        10 |        20 | +            | P53        |     0.0001  |</span>
<span class="sd">    |            1 |        20 |        20 | +            | P53        |     0.0002  |</span>
<span class="sd">    |            1 |        30 |        20 | +            | P53        |     0.0003  |</span>
<span class="sd">    |            2 |        60 |        65 | -            | FOX        |     0.05    |</span>
<span class="sd">    |            2 |        70 |        75 | -            | FOX        |     1e-07   |</span>
<span class="sd">    |            2 |        80 |        90 | -            | FOX        |     2.1e-06 |</span>
<span class="sd">    +--------------+-----------+-----------+--------------+------------+-------------+</span>
<span class="sd">    Stranded PyRanges object has 6 rows and 6 columns from 2 chromosomes.</span>
<span class="sd">    For printing, the PyRanges was sorted on Chromosome and Strand.</span>

<span class="sd">    &gt;&gt;&gt; simes = pr.stats.simes(gr.df, &quot;Gene&quot;, &quot;PValue&quot;)</span>
<span class="sd">    &gt;&gt;&gt; simes</span>
<span class="sd">      Gene         Simes</span>
<span class="sd">    0  FOX  3.000000e-07</span>
<span class="sd">    1  P53  3.000000e-04</span>

<span class="sd">    &gt;&gt;&gt; gr.apply(lambda df:</span>
<span class="sd">    ... pr.stats.simes(df, &quot;Gene&quot;, &quot;PValue&quot;, keep_position=True))</span>
<span class="sd">    +--------------+-----------+-----------+-------------+------------+------------+</span>
<span class="sd">    |   Chromosome |     Start |       End |       Simes | Strand     | Gene       |</span>
<span class="sd">    |     (object) |   (int32) |   (int32) |   (float64) | (object)   | (object)   |</span>
<span class="sd">    |--------------+-----------+-----------+-------------+------------+------------|</span>
<span class="sd">    |            1 |        10 |        20 |      0.0001 | +          | P53        |</span>
<span class="sd">    |            2 |        60 |        90 |      1e-07  | -          | FOX        |</span>
<span class="sd">    +--------------+-----------+-----------+-------------+------------+------------+</span>
<span class="sd">    Stranded PyRanges object has 2 rows and 6 columns from 2 chromosomes.</span>
<span class="sd">    For printing, the PyRanges was sorted on Chromosome and Strand.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;Strand&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">stranded</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">keep_position</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;End&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">stranded</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Strand&quot;</span><span class="p">]</span>

    <span class="n">sorter</span> <span class="o">=</span> <span class="n">groupby</span> <span class="o">+</span> <span class="p">[</span><span class="n">pcol</span><span class="p">]</span>

    <span class="n">sdf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">positions</span> <span class="o">+</span> <span class="n">sorter</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">sorter</span><span class="p">)</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">positions</span> <span class="o">+</span> <span class="n">groupby</span><span class="p">)</span>

    <span class="n">ranks</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">multiplied</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">pcol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">simes</span> <span class="o">=</span> <span class="n">multiplied</span> <span class="o">/</span> <span class="n">ranks</span>

    <span class="n">sdf</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">sdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Simes&quot;</span><span class="p">,</span> <span class="n">simes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keep_position</span><span class="p">:</span>

        <span class="n">grpby_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;Simes&quot;</span><span class="p">:</span> <span class="s2">&quot;min&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">stranded</span><span class="p">:</span>
            <span class="n">grpby_dict</span><span class="p">[</span><span class="s2">&quot;Strand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>

        <span class="n">simes</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">grpby_dict</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">simes</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">simes</span> <span class="o">=</span> <span class="n">simes</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">simes</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span><span class="o">.</span><span class="n">Simes</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">simes</span></div>



<span class="k">def</span> <span class="nf">chromsizes_as_int</span><span class="p">(</span><span class="n">chromsizes</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chromsizes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chromsizes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">chromsizes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">chromsizes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chromsizes</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">)):</span>
            <span class="n">chromsizes</span> <span class="o">=</span> <span class="n">chromsizes</span><span class="o">.</span><span class="n">End</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">chromsizes</span>


<div class="viewcode-block" id="StatisticsMethods"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.StatisticsMethods">[docs]</a><span class="k">class</span> <span class="nc">StatisticsMethods</span><span class="p">():</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Namespace for statistical comparsion-operations.</span>

<span class="sd">    Accessed with gr.stats.&quot;&quot;&quot;</span>

    <span class="n">pr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span>


<div class="viewcode-block" id="StatisticsMethods.forbes"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.StatisticsMethods.forbes">[docs]</a>    <span class="k">def</span> <span class="nf">forbes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">chromsizes</span><span class="p">,</span> <span class="n">strandedness</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Forbes coefficient.</span>

<span class="sd">        Ratio which represents observed versus expected co-occurence.</span>

<span class="sd">        Described in ``Forbes SA (1907): On the local distribution of certain Illinois fishes: an essay in statistical ecology.``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : PyRanges</span>

<span class="sd">            Intervals to compare with.</span>

<span class="sd">        chromsizes : int, dict, DataFrame or PyRanges</span>

<span class="sd">            Integer representing genome length or mapping from chromosomes</span>
<span class="sd">            to its length.</span>

<span class="sd">        strandedness : {None, &quot;same&quot;, &quot;opposite&quot;, False}, default None, i.e. &quot;auto&quot;</span>

<span class="sd">            Whether to compute without regards to strand or on same or opposite.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>

<span class="sd">            Ratio of observed versus expected co-occurence.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pyranges.statistics.jaccard : compute the jaccard coefficient</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; gr, gr2 = pr.data.chipseq(), pr.data.chipseq_background()</span>
<span class="sd">        &gt;&gt;&gt; chromsizes = pr.data.chromsizes()</span>
<span class="sd">        &gt;&gt;&gt; gr.stats.forbes(gr2, chromsizes=chromsizes)</span>
<span class="sd">        1.7168314674978278&quot;&quot;&quot;</span>

        <span class="n">chromsizes</span> <span class="o">=</span> <span class="n">chromsizes_as_int</span><span class="p">(</span><span class="n">chromsizes</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">pyranges</span><span class="o">.</span><span class="n">fill_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">strand</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strandedness&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">reference_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
        <span class="n">query_length</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>

        <span class="n">intersection_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_intersect</span><span class="p">(</span>
                    <span class="n">other</span><span class="p">,</span> <span class="n">strandedness</span><span class="o">=</span><span class="n">strandedness</span><span class="p">)</span><span class="o">.</span><span class="n">lengths</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">forbes</span> <span class="o">=</span> <span class="n">chromsizes</span> <span class="o">*</span> <span class="n">intersection_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">reference_length</span> <span class="o">*</span> <span class="n">query_length</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">forbes</span></div>


<div class="viewcode-block" id="StatisticsMethods.jaccard"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.StatisticsMethods.jaccard">[docs]</a>    <span class="k">def</span> <span class="nf">jaccard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Jaccards coefficient.</span>

<span class="sd">        Ratio of the intersection and union of two sets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : PyRanges</span>

<span class="sd">            Intervals to compare with.</span>

<span class="sd">        chromsizes : int, dict, DataFrame or PyRanges</span>

<span class="sd">            Integer representing genome length or mapping from chromosomes</span>
<span class="sd">            to its length.</span>

<span class="sd">        strandedness : {None, &quot;same&quot;, &quot;opposite&quot;, False}, default None, i.e. &quot;auto&quot;</span>

<span class="sd">            Whether to compute without regards to strand or on same or opposite.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>

<span class="sd">            Ratio of the intersection and union of two sets.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pyranges.statistics.forbes : compute the forbes coefficient</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; gr, gr2 = pr.data.chipseq(), pr.data.chipseq_background()</span>
<span class="sd">        &gt;&gt;&gt; chromsizes = pr.data.chromsizes()</span>
<span class="sd">        &gt;&gt;&gt; gr.stats.jaccard(gr2, chromsizes=chromsizes)</span>
<span class="sd">        6.657941988519211e-05&quot;&quot;&quot;</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">pyranges</span><span class="o">.</span><span class="n">fill_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">strand</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strandedness&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

        <span class="n">intersection_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_intersect</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">.</span><span class="n">lengths</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">union_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">]:</span>
            <span class="n">union_sum</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">v</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">strand</span><span class="o">=</span><span class="n">strand</span><span class="p">)</span><span class="o">.</span><span class="n">lengths</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">union_sum</span> <span class="o">-</span> <span class="n">intersection_sum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jc</span> <span class="o">=</span> <span class="n">intersection_sum</span> <span class="o">/</span> <span class="n">denominator</span>

        <span class="k">return</span> <span class="n">jc</span></div>

<div class="viewcode-block" id="StatisticsMethods.relative_distance"><a class="viewcode-back" href="../../autoapi/pyranges/statistics/index.html#pyranges.statistics.StatisticsMethods.relative_distance">[docs]</a>    <span class="k">def</span> <span class="nf">relative_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute spatial correllation between two sets.</span>

<span class="sd">        Metric which describes relative distance between each interval in one</span>
<span class="sd">        set and two closest intervals in another.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : PyRanges</span>

<span class="sd">            Intervals to compare with.</span>

<span class="sd">        chromsizes : int, dict, DataFrame or PyRanges</span>

<span class="sd">            Integer representing genome length or mapping from chromosomes</span>
<span class="sd">            to its length.</span>

<span class="sd">        strandedness : {None, &quot;same&quot;, &quot;opposite&quot;, False}, default None, i.e. &quot;auto&quot;</span>

<span class="sd">            Whether to compute without regards to strand or on same or opposite.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>

<span class="sd">            DataFrame containing the frequency of each relative distance.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>

<span class="sd">        pyranges.statistics.jaccard : compute the jaccard coefficient</span>
<span class="sd">        pyranges.statistics.forbes : compute the forbes coefficient</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; gr, gr2 = pr.data.chipseq(), pr.data.chipseq_background()</span>
<span class="sd">        &gt;&gt;&gt; chromsizes = pr.data.chromsizes()</span>
<span class="sd">        &gt;&gt;&gt; gr.stats.relative_distance(gr2)</span>
<span class="sd">            reldist  count  total  fraction</span>
<span class="sd">        0      0.00    264   9956  0.026517</span>
<span class="sd">        1      0.01    226   9956  0.022700</span>
<span class="sd">        2      0.02    206   9956  0.020691</span>
<span class="sd">        3      0.03    235   9956  0.023604</span>
<span class="sd">        4      0.04    194   9956  0.019486</span>
<span class="sd">        5      0.05    241   9956  0.024207</span>
<span class="sd">        6      0.06    201   9956  0.020189</span>
<span class="sd">        7      0.07    191   9956  0.019184</span>
<span class="sd">        8      0.08    192   9956  0.019285</span>
<span class="sd">        9      0.09    191   9956  0.019184</span>
<span class="sd">        10     0.10    186   9956  0.018682</span>
<span class="sd">        11     0.11    203   9956  0.020390</span>
<span class="sd">        12     0.12    218   9956  0.021896</span>
<span class="sd">        13     0.13    209   9956  0.020992</span>
<span class="sd">        14     0.14    201   9956  0.020189</span>
<span class="sd">        15     0.15    178   9956  0.017879</span>
<span class="sd">        16     0.16    202   9956  0.020289</span>
<span class="sd">        17     0.17    197   9956  0.019787</span>
<span class="sd">        18     0.18    208   9956  0.020892</span>
<span class="sd">        19     0.19    202   9956  0.020289</span>
<span class="sd">        20     0.20    191   9956  0.019184</span>
<span class="sd">        21     0.21    188   9956  0.018883</span>
<span class="sd">        22     0.22    213   9956  0.021394</span>
<span class="sd">        23     0.23    192   9956  0.019285</span>
<span class="sd">        24     0.24    199   9956  0.019988</span>
<span class="sd">        25     0.25    181   9956  0.018180</span>
<span class="sd">        26     0.26    172   9956  0.017276</span>
<span class="sd">        27     0.27    191   9956  0.019184</span>
<span class="sd">        28     0.28    190   9956  0.019084</span>
<span class="sd">        29     0.29    192   9956  0.019285</span>
<span class="sd">        30     0.30    201   9956  0.020189</span>
<span class="sd">        31     0.31    212   9956  0.021294</span>
<span class="sd">        32     0.32    213   9956  0.021394</span>
<span class="sd">        33     0.33    177   9956  0.017778</span>
<span class="sd">        34     0.34    197   9956  0.019787</span>
<span class="sd">        35     0.35    163   9956  0.016372</span>
<span class="sd">        36     0.36    191   9956  0.019184</span>
<span class="sd">        37     0.37    198   9956  0.019888</span>
<span class="sd">        38     0.38    160   9956  0.016071</span>
<span class="sd">        39     0.39    188   9956  0.018883</span>
<span class="sd">        40     0.40    200   9956  0.020088</span>
<span class="sd">        41     0.41    188   9956  0.018883</span>
<span class="sd">        42     0.42    230   9956  0.023102</span>
<span class="sd">        43     0.43    197   9956  0.019787</span>
<span class="sd">        44     0.44    224   9956  0.022499</span>
<span class="sd">        45     0.45    184   9956  0.018481</span>
<span class="sd">        46     0.46    198   9956  0.019888</span>
<span class="sd">        47     0.47    187   9956  0.018783</span>
<span class="sd">        48     0.48    200   9956  0.020088</span>
<span class="sd">        49     0.49    194   9956  0.019486</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">pyranges</span><span class="o">.</span><span class="n">fill_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">pyrange_apply</span><span class="p">(</span><span class="n">_relative_distance</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># pylint: disable=E1132</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="n">not_nan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">not_nan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">not_nan</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">vc</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;reldist count&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">vc</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">vc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">vc</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">vc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;fraction&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;reldist&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vc</span></div></div>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="k">def</span> <span class="nf">_mcc</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">tn</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>

    <span class="c1"># https://stackoverflow.com/a/56875660/992687</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">tp</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">tp</span> <span class="o">*</span> <span class="n">tn</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">fp</span> <span class="o">*</span> <span class="n">fn</span><span class="p">))</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>



<span class="c1"># def __tetrachoric(self, other, chromsizes, **kwargs):</span>

<span class="c1">#     self = self.pr</span>

<span class="c1">#     chromsizes = chromsizes_as_int(chromsizes)</span>

<span class="c1">#     kwargs[&quot;new_pos&quot;] = &quot;intersection&quot;</span>
<span class="c1">#     strand = True if kwargs.get(&quot;strandedness&quot;) else False</span>

<span class="c1">#     ss = self.merge(strand=strand)</span>
<span class="c1">#     so = other.merge(strand=strand)</span>
<span class="c1">#     a = ss.intersect(so, **kwargs).length</span>
<span class="c1">#     b = ss.subtract(so, **kwargs).length</span>
<span class="c1">#     c = so.subtract(ss, **kwargs).length</span>

<span class="c1">#     m = pr.concat([ss, so]).merge(strand=strand).length</span>

<span class="c1">#     d = chromsizes - m</span>

<span class="c1">#     from math import cos, sqrt</span>

<span class="c1">#     _tetrachoric = cos(180/(1 + sqrt((b * c) / (a * d))))</span>

<span class="c1">#     return _tetrachoric</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Endre Bakken Stovner and Marco Mariotti.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>